<!DOCTYPE html>
<html>
<head>
    <title>ç€‘å¸ƒæµå›¾ç‰‡æµè§ˆ</title>
    <link rel="icon" type="image/png" href="/assets/image/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        .waterfall-container {
            padding: 20px;
            column-count: 3; /* é»˜è®¤3åˆ— */
            column-gap: 15px; /* é»˜è®¤é—´è· */
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .waterfall-item {
            break-inside: avoid;
            margin-bottom: 15px;
            position: relative;
        }
        
        .waterfall-item img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px; /* é»˜è®¤åœ†è§’ */
            transition: all 0.3s ease;
        }
        
        .waterfall-item:hover img {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-panel button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .control-panel button:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 400px;
            max-width: 90vw;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-section h3 {
            margin: 0 0 15px 0;
            color: #2196F3;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .settings-row label {
            font-weight: 500;
        }
        
        .settings-row input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .button-group button.primary {
            background: #2196F3;
            color: white;
        }
        
        .button-group button.secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 1002;
            display: none;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1200px) {
            .waterfall-container {
                column-count: 3;
            }
        }
        
        @media (max-width: 768px) {
            .waterfall-container {
                column-count: 2;
            }
            button#backBtn {
                padding: 1.2rem 1.8rem;
                font-size: 1.2rem;
                bottom: 4vh;
                left: 2vw;
                min-width: 6rem;
            }
        }
        
        @media (max-width: 480px) {
            .waterfall-container {
                column-count: 1;
            }
            button#backBtn {
                padding: 1.4rem 2rem;
                font-size: 1.3rem;
                min-width: 7rem;
                bottom: 5vh;
                left: 2vw;
            }
        }
        
        /* å›¾ç‰‡æ¨¡æ€æ¡†æ ·å¼ */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-modal.show {
            opacity: 1;
        }
        
        .image-modal.fade-out {
            opacity: 0;
        }
        
        .modal-header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 10;
        }
        
        .image-title {
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .close-btn {
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
        }
        
        .modal-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .zoom-info {
            font-size: 14px;
            color: #aaa;
        }
        
        .image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .image-container img {
            max-width: 90%;
            max-height: 90%;
            display: none;
            cursor: grab;
            transform-origin: center;
            transition: transform 0.1s ease;
        }
        
        .modal-footer {
            padding: 8px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            color: #aaa;
            font-size: 12px;
        }
        
        .nav-hint {
            opacity: 0.7;
        }
        
        .loading-spinner {
            position: absolute;
            color: white;
            padding: 20px;
        }
        
        /* åº•éƒ¨åŠ è½½æŒ‡ç¤ºå™¨ */
        #bottomLoader {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        /* å¯ä»¥è°ƒæ•´æŒ‰é’®æ ·å¼ï¼Œæ¯”å¦‚ä½¿å…¶æ›´çªå‡º */
        /* .control-panel button#backBtn {
            background: #FF5722;
        }
        
        .control-panel button#backBtn:hover {
            background: #E64A19;
        } */
        
        .slider-container {
            margin-bottom: 25px;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            margin-top: 10px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #1976D2;
            transform: scale(1.1);
        }
        
        .slider::-moz-range-thumb:hover {
            background: #1976D2;
            transform: scale(1.1);
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .slider-container span {
            color: #2196F3;
            font-weight: bold;
        }
        
        .folder-navigation {
            background: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1600px;
            margin: 20px auto;
        }
        
        .breadcrumbs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .breadcrumb-item {
            color: #2196F3;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .breadcrumb-item:after {
            content: "/";
            margin-left: 5px;
            color: #888;
        }
        
        .breadcrumb-item:last-child {
            color: #333;
            font-weight: bold;
        }
        
        .breadcrumb-item:last-child:after {
            content: "";
        }
        
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        
        .folders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .folder-item {
            background: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .folder-item:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .folder-icon {
            color: #2196F3;
            font-size: 20px;
            margin-right: 10px;
        }
        
        .folder-info {
            flex: 1;
        }
        
        .folder-name {
            font-weight: 500;
        }
        
        .folder-count {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }
        
        .empty-message, .no-images-message {
            padding: 20px;
            text-align: center;
            color: #888;
            font-style: italic;
        }
        
        /* å“åº”å¼æ–‡ä»¶å¤¹ç½‘æ ¼ */
        @media (max-width: 768px) {
            .folders-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .folders-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .folder-item {
                padding: 10px;
            }
        }
        
        /* æ·»åŠ å ä½ç¬¦æ ·å¼ */
        .image-placeholder {
            position: relative;
            width: 100%;
            background-color: #f0f0f0; /* å ä½èƒŒæ™¯è‰² */
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        .image-placeholder.loaded {
            background-color: transparent;
        }
        
        .image-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            opacity: 0.8;
        }
        
        .image-placeholder.loaded::before {
            display: none;
        }
        
        .image-placeholder img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        /* æ·»åŠ æ’åºæ§åˆ¶æ ·å¼ */
        .sort-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        
        .sort-option {
            display: flex;
            align-items: center;
        }
        
        .sort-option label {
            margin-right: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .sort-option select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
        }
        
        .sort-apply-btn {
            padding: 6px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sort-apply-btn:hover {
            background-color: #1976D2;
        }
        
        @media (max-width: 768px) {
            .sort-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .sort-option {
                width: 100%;
            }
        }
        
        .folder-buttons {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* å…¨éƒ¨å›¾ç‰‡æŒ‰é’®æ ·å¼ */
        .button-group .all-folders {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* æ·»åŠ çŠ¶æ€æ æ ·å¼ */
        #scanStatus {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 4px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            font-size: 12px;
            display: block !important;
            transition: transform 0.3s ease;
        }
        
        #scanStatus.collapsed {
            transform: translateY(100%);
        }
        
        .toggle-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            background: none;
            border: none;
            padding: 0 5px;
            transition: color 0.2s ease;
        }
        
        .toggle-btn:hover {
            color: white;
        }
        
        #expandBtn {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 4px 4px 0 0;
            padding: 2px 10px;
            font-size: 10px;
            cursor: pointer;
            z-index: 999;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        
        #expandBtn.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="folder-navigation">
        <div class="breadcrumbs" id="breadcrumbs">
            <span class="breadcrumb-item active" data-path="">Home</span>
        </div>
        
        <!-- æ–°å¢æ’åºæ§åˆ¶ -->
        <div class="sort-controls">
            <div class="sort-option">
                <label for="sortBy">æ’åºæ–¹å¼:</label>
                <select id="sortBy" onchange="updateSort()">
                    <option value="name">æ–‡ä»¶å</option>
                    <option value="created">åˆ›å»ºæ—¶é—´</option>
                    <option value="modified">ä¿®æ”¹æ—¶é—´</option>
                    <option value="random">éšæœºé¡ºåº</option>
                </select>
            </div>
            <div class="sort-option">
                <label for="sortOrder">æ’åºé¡ºåº:</label>
                <select id="sortOrder" onchange="updateSort()">
                    <option value="asc">æ­£åº</option>
                    <option value="desc">å€’åº</option>
                </select>
            </div>
            <button class="sort-apply-btn" onclick="applySort()">åº”ç”¨æ’åº</button>
        </div>
        
        <div class="folders-container" id="foldersContainer">
            <!-- æ–‡ä»¶å¤¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
    
    <div id="waterfallContainer" class="waterfall-container">
        <!-- å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
    </div>
    
    <div class="control-panel">
        <button id="refreshBtn" onclick="loadImages()">åˆ·æ–°å›¾ç‰‡</button>
        <button id="settingsBtn" onclick="showSettings()">å¸ƒå±€è®¾ç½®</button>
        <button id="backBtn" onclick="location.href='/'" style="position: fixed; padding: 1rem 1.5rem; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 0.5rem; z-index: 100; bottom: 3vh; left: 2vw; font-size: 1rem; box-shadow: 0 0.125rem 0.625rem rgba(0,0,0,0.2); transition: all 0.3s ease; min-width: 5rem;">è¿”å›å•å›¾</button>
    </div>
    
    <div id="settingsModal" class="settings-modal">
        <div class="settings-section">
            <h3>ç€‘å¸ƒæµå¸ƒå±€è®¾ç½®</h3>
            
            <div class="slider-container">
                <label for="columnCount">åˆ—æ•°: <span id="columnValue">3</span></label>
                <input type="range" id="columnCount" min="1" max="10" value="3" class="slider">
            </div>
            
            <div class="slider-container">
                <label for="columnGap">åˆ—é—´è· (px): <span id="gapValue">15</span></label>
                <input type="range" id="columnGap" min="0" max="50" value="15" class="slider">
            </div>
            
            <div class="slider-container">
                <label for="imageGap">å›¾ç‰‡é—´è· (px): <span id="imageGapValue">15</span></label>
                <input type="range" id="imageGap" min="0" max="50" value="15" class="slider">
            </div>
            
            <div class="slider-container">
                <label for="borderRadius">åœ†è§’å¤§å° (px): <span id="radiusValue">8</span></label>
                <input type="range" id="borderRadius" min="0" max="50" value="8" class="slider">
            </div>
        </div>
        
        <div class="button-group">
            <button class="primary" onclick="applySettings()">åº”ç”¨è®¾ç½®</button>
            <button class="secondary" onclick="closeSettings()">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="loadingIndicator" class="loading">åŠ è½½ä¸­...</div>
    <div id="overlay" class="overlay"></div>
    
    <!-- åº•éƒ¨åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="bottomLoader">åŠ è½½æ›´å¤šå›¾ç‰‡...</div>
    
    <!-- çŠ¶æ€æ  -->
    <div id="scanStatus">
        <span id="statusText">æ­£åœ¨è·å–çŠ¶æ€...</span>
        <button class="toggle-btn" id="collapseBtn" title="æ”¶èµ·çŠ¶æ€æ ">â–¼</button>
    </div>
    
    <!-- æ·»åŠ å±•å¼€æŒ‰é’® -->
    <button id="expandBtn" title="å±•å¼€çŠ¶æ€æ ">â–² çŠ¶æ€</button>
    
    <script>
        // å…¨å±€è®¾ç½®å˜é‡
        let waterfallSettings = {
            columnCount: 3,
            columnGap: 15,
            imageGap: 15,
            borderRadius: 8
        };
        
        // å½“å‰æ–‡ä»¶å¤¹è·¯å¾„
        let currentFolderPath = '';
        
        // æ·»åŠ æ’åºè®¾ç½®å˜é‡
        let sortSettings = {
            sortBy: 'name',
            sortOrder: 'asc'
        };
        
        // è·å–æ’åºè®¾ç½®
        function updateSort() {
            sortSettings.sortBy = document.getElementById('sortBy').value;
            sortSettings.sortOrder = document.getElementById('sortOrder').value;
        }
        
        // åº”ç”¨æ’åº
        function applySort() {
            updateSort();
            // é‡ç½®é¡µé¢å¹¶é‡æ–°åŠ è½½å›¾ç‰‡
            currentPage = 1;
            hasMoreImages = true;
            loadImages(1, 20, currentFolderPath);
        }
        
        // åŠ è½½æœåŠ¡å™¨ç«¯å­˜å‚¨çš„è®¾ç½®
        async function loadSettings() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            try {
                const response = await fetch('/get-waterfall-settings');
                if (!response.ok) {
                    throw new Error('æœåŠ¡å™¨é”™è¯¯');
                }
                
                const settings = await response.json();
                waterfallSettings = settings;
                
                // åº”ç”¨è®¾ç½®
                applyWaterfallSettings();
                
                // åˆå§‹åŒ–è®¾ç½®è¡¨å•
                initSettingsForm();
                
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤è®¾ç½®
                applyWaterfallSettings();
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // åº”ç”¨è®¾ç½®åˆ°é¡µé¢
        function applyWaterfallSettings() {
            const container = document.getElementById('waterfallContainer');
            container.style.columnCount = waterfallSettings.columnCount;
            container.style.columnGap = waterfallSettings.columnGap + 'px';
            
            const items = document.querySelectorAll('.waterfall-item');
            items.forEach(item => {
                item.style.marginBottom = waterfallSettings.imageGap + 'px';
                const img = item.querySelector('img');
                if (img) {
                    img.style.borderRadius = waterfallSettings.borderRadius + 'px';
                }
            });
        }
        
        // åˆå§‹åŒ–è®¾ç½®è¡¨å•
        function initSettingsForm() {
            document.getElementById('columnCount').value = waterfallSettings.columnCount;
            document.getElementById('columnGap').value = waterfallSettings.columnGap;
            document.getElementById('imageGap').value = waterfallSettings.imageGap;
            document.getElementById('borderRadius').value = waterfallSettings.borderRadius;
            
            // æ›´æ–°æ˜¾ç¤ºçš„å€¼
            document.getElementById('columnValue').textContent = waterfallSettings.columnCount;
            document.getElementById('gapValue').textContent = waterfallSettings.columnGap;
            document.getElementById('imageGapValue').textContent = waterfallSettings.imageGap;
            document.getElementById('radiusValue').textContent = waterfallSettings.borderRadius;
            
            // æ·»åŠ æ»‘å—äº‹ä»¶ç›‘å¬å™¨
            setupSliderListeners();
        }
        
        // è®¾ç½®æ»‘å—äº‹ä»¶ç›‘å¬å™¨ï¼Œå®æ—¶åæ˜ è®¾ç½®å˜åŒ–
        function setupSliderListeners() {
            document.getElementById('columnCount').addEventListener('input', function() {
                document.getElementById('columnValue').textContent = this.value;
                // å®æ—¶åº”ç”¨åˆ—æ•°å˜åŒ–
                const container = document.getElementById('waterfallContainer');
                container.style.columnCount = this.value;
                
                // å»¶è¿Ÿæ£€æŸ¥å†…å®¹é«˜åº¦
                clearTimeout(this.heightCheckTimer);
                this.heightCheckTimer = setTimeout(() => {
                    checkContentHeight();
                }, 300);
            });
            
            document.getElementById('columnGap').addEventListener('input', function() {
                document.getElementById('gapValue').textContent = this.value;
                // å®æ—¶åº”ç”¨åˆ—é—´è·å˜åŒ–
                const container = document.getElementById('waterfallContainer');
                container.style.columnGap = this.value + 'px';
            });
            
            document.getElementById('imageGap').addEventListener('input', function() {
                document.getElementById('imageGapValue').textContent = this.value;
                // å®æ—¶åº”ç”¨å›¾ç‰‡é—´è·å˜åŒ–
                const items = document.querySelectorAll('.waterfall-item');
                items.forEach(item => {
                    item.style.marginBottom = this.value + 'px';
                });
            });
            
            document.getElementById('borderRadius').addEventListener('input', function() {
                document.getElementById('radiusValue').textContent = this.value;
                // å®æ—¶åº”ç”¨åœ†è§’å˜åŒ–
                const imgs = document.querySelectorAll('.waterfall-item img');
                imgs.forEach(img => {
                    img.style.borderRadius = this.value + 'px';
                });
            });
        }
        
        // æ˜¾ç¤ºè®¾ç½®å¼¹çª—
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            initSettingsForm();
        }
        
        // å…³é—­è®¾ç½®å¼¹çª—
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        
        // ä¿å­˜è®¾ç½®åˆ°æœåŠ¡å™¨
        async function applySettings() {
            // è·å–å½“å‰æ»‘å—å€¼
            waterfallSettings.columnCount = parseInt(document.getElementById('columnCount').value);
            waterfallSettings.columnGap = parseInt(document.getElementById('columnGap').value);
            waterfallSettings.imageGap = parseInt(document.getElementById('imageGap').value);
            waterfallSettings.borderRadius = parseInt(document.getElementById('borderRadius').value);
            
            // ä¿è¯borderRadiusä¸º0æ—¶ç¡®å®åº”ç”¨ä¸º0px
            const borderRadiusValue = waterfallSettings.borderRadius + 'px';
            
            // åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡å’Œå ä½ç¬¦
            const imgs = document.querySelectorAll('.waterfall-item img');
            imgs.forEach(img => {
                img.style.borderRadius = borderRadiusValue;
            });
            
            const placeholders = document.querySelectorAll('.image-placeholder');
            placeholders.forEach(placeholder => {
                placeholder.style.borderRadius = borderRadiusValue;
            });
            
            // ä¿å­˜åˆ°æœåŠ¡å™¨
            try {
                const response = await fetch('/save-waterfall-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(waterfallSettings)
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'ä¿å­˜è®¾ç½®å¤±è´¥');
                }
                
                // ä¿å­˜æˆåŠŸæç¤º
                const message = document.createElement('div');
                message.textContent = 'è®¾ç½®å·²ä¿å­˜';
                message.style.position = 'fixed';
                message.style.bottom = '80px';
                message.style.right = '20px';
                message.style.padding = '10px 20px';
                message.style.background = '#4CAF50';
                message.style.color = 'white';
                message.style.borderRadius = '4px';
                message.style.zIndex = '2000';
                document.body.appendChild(message);
                
                // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    document.body.removeChild(message);
                }, 2000);
                
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                alert('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
            }
            
            // å…³é—­å¼¹çª—
            closeSettings();
            
            // åœ¨ä¿å­˜è®¾ç½®æˆåŠŸåï¼Œæ£€æŸ¥å†…å®¹é«˜åº¦
            setTimeout(() => {
                checkContentHeight();
            }, 500);
        }
        
        // åŠ è½½æ–‡ä»¶å¤¹ç»“æ„
        async function loadFolders(path = '') {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            try {
                const response = await fetch(`/get-folders?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    throw new Error('åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥');
                }
                
                const data = await response.json();
                currentFolderPath = data.currentPath;
                
                // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
                updateBreadcrumbs(data.breadcrumbs);
                
                // æ˜¾ç¤ºæ–‡ä»¶å¤¹
                const foldersContainer = document.getElementById('foldersContainer');
                foldersContainer.innerHTML = '';
                
                if (data.folders.length === 0) {
                    // å¦‚æœæ²¡æœ‰æ–‡ä»¶å¤¹ï¼Œæ˜¾ç¤ºæç¤º
                    if (data.images.length === 0) {
                        foldersContainer.innerHTML = '<div class="empty-message">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
                    } else {
                        foldersContainer.innerHTML = '<div class="empty-message">æ­¤æ–‡ä»¶å¤¹æ²¡æœ‰å­æ–‡ä»¶å¤¹</div>';
                    }
                } else {
                    // æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶å¤¹
                    data.folders.forEach(folder => {
                        const folderItem = document.createElement('div');
                        folderItem.className = 'folder-item';
                        folderItem.innerHTML = `
                            <span class="folder-icon">ğŸ“</span>
                            <div class="folder-info">
                                <div class="folder-name">${folder.name}</div>
                                <div class="folder-count">${folder.imageCount} å¼ å›¾ç‰‡</div>
                            </div>
                        `;
                        folderItem.onclick = () => navigateToFolder(folder.path);
                        foldersContainer.appendChild(folderItem);
                    });
                }
                
                // åŠ è½½å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„å›¾ç‰‡
                currentPage = 1;
                hasMoreImages = true;
                await loadImages(1, 20, currentFolderPath);
                
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥:', error);
                alert('åŠ è½½æ–‡ä»¶å¤¹ç»“æ„å¤±è´¥');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumbs(breadcrumbs) {
            const breadcrumbsContainer = document.getElementById('breadcrumbs');
            breadcrumbsContainer.innerHTML = '';
            
            // æ·»åŠ æ ¹ç›®å½•ï¼Œå°†"Root"æ”¹ä¸º"Home"
            const rootItem = document.createElement('span');
            rootItem.className = 'breadcrumb-item';
            rootItem.textContent = 'Home';
            rootItem.dataset.path = '';
            rootItem.onclick = () => navigateToFolder('');
            breadcrumbsContainer.appendChild(rootItem);
            
            // æ·»åŠ è·¯å¾„å±‚çº§
            breadcrumbs.forEach(crumb => {
                const item = document.createElement('span');
                item.className = 'breadcrumb-item';
                item.textContent = crumb.name;
                item.dataset.path = crumb.path;
                item.onclick = () => navigateToFolder(crumb.path);
                breadcrumbsContainer.appendChild(item);
            });
            
            // æ ‡è®°æœ€åä¸€ä¸ªä¸ºæ´»åŠ¨çŠ¶æ€
            const items = breadcrumbsContainer.querySelectorAll('.breadcrumb-item');
            if (items.length > 0) {
                items[items.length - 1].classList.add('active');
            }
        }
        
        // å¯¼èˆªåˆ°ç‰¹å®šæ–‡ä»¶å¤¹
        function navigateToFolder(path) {
            loadFolders(path);
        }
        
        // ä¿®æ”¹loadImageså‡½æ•°ï¼Œæ·»åŠ å¯¹é¡µé¢é«˜åº¦ä¸è¶³çš„æ£€æµ‹
        async function loadImages(page = 1, limit = 20, folderPath = '', retryCount = 0) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const container = document.getElementById('waterfallContainer');
            
            try {
                if (page === 1) {
                    container.innerHTML = '';
                    loadingIndicator.style.display = 'block';
                }
                
                // æ·»åŠ æ€§èƒ½æç¤º
                if (page === 1) {
                    const message = document.createElement('div');
                    message.textContent = 'æ­£åœ¨åŠ è½½å›¾ç‰‡ï¼Œé¦–æ¬¡åŠ è½½å¯èƒ½è¾ƒæ…¢...';
                    message.style.textAlign = 'center';
                    message.style.padding = '20px';
                    message.style.color = '#666';
                    message.id = 'loading-message';
                    container.appendChild(message);
                }
                
                // åŠ è½½å›¾ç‰‡çš„è¯·æ±‚
                const response = await fetch(`/list-images?page=${page}&limit=${limit}&path=${encodeURIComponent(folderPath)}&sort_by=${sortSettings.sortBy}&sort_order=${sortSettings.sortOrder}`);
                
                // ç§»é™¤æ€§èƒ½æç¤º
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
                
                if (!response.ok) {
                    throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯: ' + response.status);
                }
                
                const data = await response.json();
                
                const images = data.images;
                const hasMore = data.hasMore;
                
                if (!images || !images.length) {
                    if (page === 1) {
                        container.innerHTML = '<div class="no-images-message">æ­¤æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰å›¾ç‰‡</div>';
                    }
                    return false;
                }
                
                // æ·»åŠ å›¾ç‰‡
                images.forEach(image => {
                    const item = document.createElement('div');
                    item.className = 'waterfall-item';
                    
                    // åˆ›å»ºå ä½å®¹å™¨
                    const placeholder = document.createElement('div');
                    placeholder.className = 'image-placeholder';
                    
                    const img = document.createElement('img');
                    img.loading = 'lazy'; // æ‡’åŠ è½½
                    
                    // å¦‚æœæœ‰å°ºå¯¸ä¿¡æ¯ï¼Œè®¾ç½®å ä½ç¬¦å®½é«˜æ¯”
                    if (image.width && image.height) {
                        const aspectRatio = (image.height / image.width) * 100;
                        placeholder.style.paddingBottom = `${aspectRatio}%`;
                        // å‚¨å­˜åŸå§‹å®½é«˜æ¯”ï¼Œç”¨äºç¼©æ”¾è®¡ç®—
                        img.dataset.aspectRatio = aspectRatio;
                    } else {
                        // é»˜è®¤å®½é«˜æ¯”(16:9)
                        placeholder.style.paddingBottom = '75%';
                    }
                    
                    // å›¾ç‰‡è·¯å¾„ä¿¡æ¯
                    const imgPath = typeof image === 'string' ? image : image.path;
                    
                    // åœ¨loadImageså‡½æ•°ä¸­ä¿®æ”¹åˆ—æ•°æ„ŸçŸ¥çš„ç¼©ç•¥å›¾å°ºå¯¸
                    function getOptimalThumbnailSize(columnCount) {
                        if (columnCount < 5) return 800; // 5åˆ—ä»¥ä¸‹ä½¿ç”¨800pxå®½åº¦
                        return 400; // 5åˆ—åŠä»¥ä¸Šä½¿ç”¨400pxå®½åº¦
                    }
                    
                    // ç„¶ååœ¨è®¾ç½®å›¾ç‰‡srcæ—¶
                    const thumbnailWidth = getOptimalThumbnailSize(waterfallSettings.columnCount);
                    img.src = `/img-thumbnail/${imgPath}?w=${thumbnailWidth}&t=${Date.now()}`;
                    img.alt = imgPath;
                    img.dataset.fullImage = `/img-static/${imgPath}`;
                    
                    img.onerror = () => {
                        img.src = '/assets/image/error.png';
                    };
                    
                    // æ·»åŠ ç‚¹å‡»æŸ¥çœ‹å¤§å›¾åŠŸèƒ½
                    img.onclick = () => {
                        showFullImage(img.dataset.fullImage, imgPath);
                    };
                    
                    // å›¾ç‰‡åŠ è½½å®Œæˆåçš„å¤„ç†
                    img.onload = () => {
                        // æ˜¾ç¤ºå›¾ç‰‡ï¼Œéšè—å ä½èƒŒæ™¯
                        img.style.opacity = 1;
                        placeholder.classList.add('loaded');
                    };
                    
                    // å°†å›¾ç‰‡æ·»åŠ åˆ°å ä½ç¬¦å†…
                    placeholder.appendChild(img);
                    item.appendChild(placeholder);
                    container.appendChild(item);
                });
                
                // åº”ç”¨ç€‘å¸ƒæµè®¾ç½®
                applyWaterfallSettings();
                
                // æ£€æµ‹å†…å®¹é«˜åº¦æ˜¯å¦å¡«æ»¡é¡µé¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤š
                setTimeout(() => {
                    checkContentHeight();
                }, 500); // ç­‰å¾…å›¾ç‰‡åŠ è½½å’Œæ’åˆ—
                
                return hasMore; // è¿”å›æ˜¯å¦è¿˜æœ‰æ›´å¤šå›¾ç‰‡
                
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                
                // æ·»åŠ é‡è¯•æœºåˆ¶
                if (retryCount < 3) {
                    console.log(`å°è¯•é‡æ–°åŠ è½½ (${retryCount + 1}/3)...`);
                    // å»¶è¿Ÿ1ç§’åé‡è¯•
                    setTimeout(() => {
                        loadImages(page, limit, folderPath, retryCount + 1);
                    }, 1000);
                    return true; // è¿”å›trueè¡¨ç¤ºæ­£åœ¨é‡è¯•
                }
                
                if (page === 1) {
                    container.innerHTML = '<div class="no-images-message">åŠ è½½å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                }
                return false;
            } finally {
                if (page === 1) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }
        
        // æ·»åŠ æ£€æŸ¥å†…å®¹é«˜åº¦çš„å‡½æ•°
        function checkContentHeight() {
            if (isLoading || !hasMoreImages) return;
            
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            
            // å¦‚æœå†…å®¹é«˜åº¦ä¸è¶³ä»¥è§¦å‘æ»šåŠ¨ï¼Œä¸”è¿˜æœ‰æ›´å¤šå›¾ç‰‡ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤š
            if (scrollHeight <= clientHeight + 50 && hasMoreImages) {
                console.log('å†…å®¹é«˜åº¦ä¸è¶³ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤šå›¾ç‰‡');
                loadMoreImages();
            }
        }
        
        // æ˜¾ç¤ºå…¨å°ºå¯¸å›¾ç‰‡çš„å¼¹çª—
        function showFullImage(imageSrc, imageName) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="modal-header">
                    <span class="image-title">${imageName}</span>
                    <div class="modal-controls">
                        <span class="zoom-info">ç¼©æ”¾: 100%</span>
                        <span class="close-btn">&times;</span>
                    </div>
                </div>
                <div class="image-container">
                    <img src="" alt="${imageName}">
                </div>
                <div class="modal-footer">
                    <div class="nav-hint">â† â†’ åˆ‡æ¢å›¾ç‰‡ | æ»šè½®ç¼©æ”¾ | Ctrl+æ»šè½®åˆ‡æ¢å›¾ç‰‡ | æ‹–æ‹½ç§»åŠ¨</div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const closeBtn = modal.querySelector('.close-btn');
            const imageContainer = modal.querySelector('.image-container');
            const modalImg = modal.querySelector('img');
            const zoomInfo = modal.querySelector('.zoom-info');
            
            // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            spinner.textContent = 'åŠ è½½ä¸­...';
            imageContainer.appendChild(spinner);
            
            // ç¼©æ”¾å’Œæ‹–æ‹½çŠ¶æ€å˜é‡
            let scale = 1;
            let isDragging = false;
            let startX = 0, startY = 0;
            let translateX = 0, translateY = 0;
            
            // è®¾ç½®åˆå§‹æ ·å¼
            modalImg.style.transform = `scale(1) translate(0px, 0px)`;
            imageContainer.style.cursor = 'grab';
            
            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.onclick = () => {
                modal.classList.add('fade-out');
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            };
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeBtn.onclick();
                }
            });
            
            // æ»šè½®ç¼©æ”¾ - ç›´æ¥ä½¿ç”¨æ»šè½®ç¼©æ”¾ï¼Œæ— éœ€Ctrlé”®
            modal.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    // Ctrl+æ»šè½®åˆ‡æ¢å›¾ç‰‡
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        navigateImages(-1); // ä¸Šä¸€å¼ 
                    } else {
                        navigateImages(1);  // ä¸‹ä¸€å¼ 
                    }
                } else {
                    // æ™®é€šæ»šè½®ç›´æ¥ç¼©æ”¾
                    e.preventDefault();
                    
                    // åˆ¤æ–­æ˜¯æ”¾å¤§è¿˜æ˜¯ç¼©å°
                    const delta = e.deltaY < 0 ? 0.1 : -0.1;
                    let newScale = scale + delta;
                    
                    // æ”¾å®½é™åˆ¶èŒƒå›´ï¼šä»0.1-5æ”¹ä¸º0.1-10
                    newScale = Math.max(0.1, Math.min(10, newScale));
                    
                    // æ›´æ–°ç¼©æ”¾çŠ¶æ€
                    scale = newScale;
                    
                    // æ˜¾ç¤ºç¼©æ”¾ç™¾åˆ†æ¯”
                    zoomInfo.textContent = `ç¼©æ”¾: ${Math.round(scale * 100)}%`;
                    
                    // åº”ç”¨ç¼©æ”¾
                    updateTransform();
                }
            });
            
            // é¼ æ ‡æ‹–æ‹½ - åœ¨ä»»ä½•ç¼©æ”¾çº§åˆ«éƒ½å¯æ‹–åŠ¨
            imageContainer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                imageContainer.style.cursor = 'grabbing';
            });
            
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            });
            
            window.addEventListener('mouseup', () => {
                isDragging = false;
                imageContainer.style.cursor = 'grab';
            });
            
            // æ›´æ–°å˜æ¢
            function updateTransform() {
                modalImg.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
            }
            
            // é”®ç›˜å¯¼èˆª
            window.addEventListener('keydown', handleKeydown);
            
            function handleKeydown(e) {
                // ç¡®ä¿æ¨¡æ€æ¡†ä»ç„¶å­˜åœ¨
                if (!document.body.contains(modal)) {
                    window.removeEventListener('keydown', handleKeydown);
                    return;
                }
                
                // ä½¿ç”¨å·¦å³ç®­å¤´å¯¼èˆª
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateImages(-1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateImages(1);
                } else if (e.key === 'Escape') {
                    closeBtn.onclick();
                }
            }
            
            // å¯¼èˆªåˆ°ä¸Šä¸€å¼ /ä¸‹ä¸€å¼ 
            function navigateImages(direction) {
                // è·å–å½“å‰æ‰€æœ‰å›¾ç‰‡
                const allImages = Array.from(document.querySelectorAll('.waterfall-item img'));
                const currentImagePath = imageSrc;
                
                // æ‰¾åˆ°å½“å‰å›¾ç‰‡çš„ç´¢å¼•
                let currentIndex = allImages.findIndex(img => img.dataset.fullImage === currentImagePath);
                
                if (currentIndex !== -1) {
                    // è®¡ç®—ä¸‹ä¸€ä¸ªç´¢å¼•
                    let nextIndex = currentIndex + direction;
                    
                    // å¾ªç¯å¯¼èˆª
                    if (nextIndex < 0) nextIndex = allImages.length - 1;
                    if (nextIndex >= allImages.length) nextIndex = 0;
                    
                    // è·å–ä¸‹ä¸€å¼ å›¾ç‰‡ä¿¡æ¯
                    const nextImage = allImages[nextIndex];
                    
                    // å…³é—­å½“å‰æ¨¡æ€æ¡†
                    document.body.removeChild(modal);
                    
                    // æ‰“å¼€æ–°å›¾ç‰‡
                    showFullImage(nextImage.dataset.fullImage, nextImage.alt);
                }
            }
            
            // é‡ç½®çŠ¶æ€å‡½æ•°
            function resetZoom() {
                scale = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
                zoomInfo.textContent = `ç¼©æ”¾: 100%`;
            }
            
            // åŒå‡»é‡ç½®ç¼©æ”¾
            modalImg.addEventListener('dblclick', resetZoom);
            
            // åŠ è½½å¤§å›¾
            modalImg.onload = () => {
                spinner.remove();
                modalImg.style.display = 'block';
            };
            
            modalImg.onerror = () => {
                spinner.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
            };
            
            // å¼€å§‹åŠ è½½å¤§å›¾
            modalImg.src = imageSrc;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // å®ç°æ— é™æ»šåŠ¨
        let currentPage = 1;
        let isLoading = false;
        let hasMoreImages = true;
        
        function setupInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if (isLoading || !hasMoreImages) return;
                
                const scrollHeight = document.documentElement.scrollHeight;
                const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                const clientHeight = document.documentElement.clientHeight;
                
                // å½“æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨500pxèŒƒå›´å†…æ—¶åŠ è½½æ›´å¤š
                if (scrollTop + clientHeight + 500 >= scrollHeight) {
                    loadMoreImages();
                }
            });
        }
        
        async function loadMoreImages() {
            if (isLoading || !hasMoreImages) return;
            
            isLoading = true;
            currentPage++;
            
            // æ˜¾ç¤ºåº•éƒ¨åŠ è½½æŒ‡ç¤ºå™¨
            const bottomLoader = document.getElementById('bottomLoader');
            if (bottomLoader) bottomLoader.style.display = 'block';
            
            hasMoreImages = await loadImages(currentPage, 20, currentFolderPath);
            
            isLoading = false;
            if (bottomLoader) bottomLoader.style.display = 'none';
        }
        
        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ’åºé€‰é¡¹
        window.onload = () => {
            currentPage = 1;
            isLoading = false;
            hasMoreImages = true;
            
            // åˆå§‹åŒ–æ’åºæ§ä»¶
            document.getElementById('sortBy').value = sortSettings.sortBy;
            document.getElementById('sortOrder').value = sortSettings.sortOrder;
            
            // åˆå§‹åŒ–çŠ¶æ€æ 
            initStatusBar();
            
            // åˆå§‹åŒ–çŠ¶æ€æ 
            const scanStatusElement = document.getElementById('scanStatus');
            const statusTextElement = document.getElementById('statusText');
            if (scanStatusElement && statusTextElement) {
                scanStatusElement.style.display = 'block';
                statusTextElement.textContent = 'æ­£åœ¨è·å–çŠ¶æ€...';
            }
            
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            checkProgressStatus();
            
            // å…ˆåŠ è½½è®¾ç½®ï¼Œå†åŠ è½½æ–‡ä»¶å¤¹ç»“æ„
            loadSettings().then(() => {
                loadFolders().then(() => {
                    setupInfiniteScroll();
                    
                    // è®¾ç½®å®šæ—¶æ›´æ–°çŠ¶æ€æ 
                    setInterval(checkProgressStatus, 2000);
                });
            });
        };
        
        // ä¿®æ”¹åˆ·æ–°æŒ‰é’®çš„åŠŸèƒ½ï¼Œä¿æŒå½“å‰æ–‡ä»¶å¤¹è·¯å¾„
        document.getElementById('refreshBtn').onclick = async function() {
            // æ¸…é™¤æœåŠ¡å™¨ç¼“å­˜
            try {
                await fetch('/clear-cache', { method: 'POST' });
                console.log('æœåŠ¡å™¨ç¼“å­˜å·²æ¸…é™¤');
                addLog('æœåŠ¡å™¨ç¼“å­˜å·²æ¸…é™¤');
            } catch (e) {
                console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', e);
                addLog('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + e.message);
            }
            
            // é‡æ–°åŠ è½½å½“å‰æ–‡ä»¶å¤¹çš„å›¾ç‰‡
            currentPage = 1;
            hasMoreImages = true;
            
            // ä½¿ç”¨å½“å‰æ–‡ä»¶å¤¹è·¯å¾„é‡æ–°åŠ è½½å›¾ç‰‡ï¼Œè€Œä¸æ˜¯åŠ è½½æ ¹ç›®å½•
            loadImages(1, 20, currentFolderPath);
        };

        // è¿›åº¦é¢æ¿å’Œæ—¥å¿—é¢æ¿ç›¸å…³å‡½æ•°
        function hideProgressPanel() {
            document.getElementById('progressPanel').style.display = 'none';
            addLog('è¿›åº¦é¢æ¿å·²å…³é—­');
        }

        function hideLogPanel() {
            document.getElementById('logPanel').style.display = 'none';
        }

        function toggleLogPanel() {
            const logPanel = document.getElementById('logPanel');
            logPanel.style.display = logPanel.style.display === 'none' ? 'block' : 'none';
            addLog('æ—¥å¿—é¢æ¿å·²' + (logPanel.style.display === 'none' ? 'å…³é—­' : 'æ‰“å¼€'));
        }

        function addLog(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logContent.innerHTML = logEntry + '<br>' + logContent.innerHTML;
        }

        // æ£€æŸ¥è¿›åº¦çŠ¶æ€
        function checkProgressStatus() {
            // æ£€æŸ¥æ‰«æçŠ¶æ€
            fetch('/scan-status?manual=true')
                .then(response => response.json())
                .then(data => {
                    updateScanStatus(data);
                })
                .catch(error => {
                    console.error('è·å–æ‰«æçŠ¶æ€å¤±è´¥:', error);
                });
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateScanStatus(data) {
            const scanStatusElement = document.getElementById('scanStatus');
            const statusTextElement = document.getElementById('statusText');
            
            if (!scanStatusElement || !statusTextElement) {
                console.error('æ‰¾ä¸åˆ°çŠ¶æ€æ å…ƒç´ ');
                return;
            }
            
            let statusText = '';
            
            if (data.is_scanning && data.is_manual_scan) {
                // æ‰«æä¸­çŠ¶æ€
                statusText = `æ‰«æä¸­: ${data.current_file || 'æœªçŸ¥'} | è¿›åº¦: ${data.processed_files || 0}/${data.total_files || 0} | æœ‰æ•ˆå›¾ç‰‡: ${data.valid_images || 0} | ç”¨æ—¶: ${data.duration || 0}ç§’`;
            } else {
                // å°±ç»ªçŠ¶æ€ï¼Œæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
                statusText = `å°±ç»ª | æ€»æ–‡ä»¶æ•°: ${data.total_files || 0} | æœ‰æ•ˆå›¾ç‰‡: ${data.valid_images || 0}`;
                
                // å¦‚æœæœ‰ç¼©ç•¥å›¾ä¿¡æ¯ï¼Œæ·»åŠ åˆ°çŠ¶æ€æ 
                fetch('/thumbnail-status')
                    .then(response => response.json())
                    .then(thumbData => {
                        if (thumbData.is_generating) {
                            statusText += ` | ç¼©ç•¥å›¾: ${thumbData.processed || 0}/${thumbData.total || 0}`;
                        } else if (thumbData.total > 0) {
                            statusText += ` | ç¼©ç•¥å›¾: å·²å®Œæˆ (${thumbData.total || 0}å¼ )`;
                        }
                        statusTextElement.textContent = statusText;
                    })
                    .catch(error => {
                        console.error('è·å–ç¼©ç•¥å›¾çŠ¶æ€å¤±è´¥:', error);
                        statusTextElement.textContent = statusText;
                    });
            }
            
            // å¦‚æœæ˜¯æ‰«æçŠ¶æ€ï¼Œç›´æ¥æ›´æ–°å†…å®¹
            if (data.is_scanning && data.is_manual_scan) {
                statusTextElement.textContent = statusText;
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        function checkForActiveProcesses() {
            fetch('/scan-status?manual=true')
                .then(response => response.json())
                .then(data => {
                    if (data.is_scanning) {
                        addLog('æ£€æµ‹åˆ°æ­£åœ¨è¿›è¡Œçš„æ‰«æä»»åŠ¡');
                    }
                    
                    // æ£€æŸ¥ç¼©ç•¥å›¾çŠ¶æ€
                    fetch('/thumbnail-status')
                        .then(response => response.json())
                        .then(data => {
                            if (data.is_generating) {
                                addLog('æ£€æµ‹åˆ°æ­£åœ¨è¿›è¡Œçš„ç¼©ç•¥å›¾ç”Ÿæˆä»»åŠ¡');
                            }
                        })
                        .catch(() => {
                            // å¿½ç•¥é”™è¯¯
                        });
                })
                .catch(error => {
                    console.error('æ£€æŸ¥è¿›ç¨‹çŠ¶æ€å¤±è´¥:', error);
                });
        }

        // åˆå§‹åŒ–çŠ¶æ€æ çš„æ”¶èµ·/å±•å¼€åŠŸèƒ½
        function initStatusBar() {
            const scanStatus = document.getElementById('scanStatus');
            const collapseBtn = document.getElementById('collapseBtn');
            const expandBtn = document.getElementById('expandBtn');
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½çŠ¶æ€æ çŠ¶æ€
            const isCollapsed = localStorage.getItem('statusBarCollapsed') === 'true';
            if (isCollapsed) {
                scanStatus.classList.add('collapsed');
                expandBtn.classList.add('visible');
            }
            
            // æ”¶èµ·æŒ‰é’®
            collapseBtn.addEventListener('click', () => {
                scanStatus.classList.add('collapsed');
                expandBtn.classList.add('visible');
                localStorage.setItem('statusBarCollapsed', 'true');
            });
            
            // å±•å¼€æŒ‰é’®
            expandBtn.addEventListener('click', () => {
                scanStatus.classList.remove('collapsed');
                expandBtn.classList.remove('visible');
                localStorage.setItem('statusBarCollapsed', 'false');
            });
        }
    </script>
</body>
</html> 