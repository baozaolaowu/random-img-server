<!DOCTYPE html>
<html>
<head>
    <title>瀑布流图片浏览</title>
    <link rel="icon" type="image/png" href="/assets/image/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        .waterfall-container {
            padding: 20px;
            column-count: 3; /* 默认3列 */
            column-gap: 15px; /* 默认间距 */
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .waterfall-item {
            break-inside: avoid;
            margin-bottom: 15px;
            position: relative;
        }
        
        .waterfall-item img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px; /* 默认圆角 */
            transition: all 0.3s ease;
        }
        
        .waterfall-item:hover img {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-panel button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .control-panel button:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 400px;
            max-width: 90vw;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-section h3 {
            margin: 0 0 15px 0;
            color: #2196F3;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .settings-row label {
            font-weight: 500;
        }
        
        .settings-row input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .button-group button.primary {
            background: #2196F3;
            color: white;
        }
        
        .button-group button.secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 1002;
            display: none;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        /* 响应式布局 */
        @media (max-width: 1200px) {
            .waterfall-container {
                column-count: 3;
            }
        }
        
        @media (max-width: 768px) {
            .waterfall-container {
                column-count: 2;
            }
            button#backBtn {
                padding: 1.2rem 1.8rem;
                font-size: 1.2rem;
                bottom: 4vh;
                left: 2vw;
                min-width: 6rem;
            }
        }
        
        @media (max-width: 480px) {
            .waterfall-container {
                column-count: 1;
            }
            button#backBtn {
                padding: 1.4rem 2rem;
                font-size: 1.3rem;
                min-width: 7rem;
                bottom: 5vh;
                left: 2vw;
            }
        }
        
        /* 图片模态框样式 */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-modal.show {
            opacity: 1;
        }
        
        .image-modal.fade-out {
            opacity: 0;
        }
        
        .modal-header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 10;
        }
        
        .image-title {
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .close-btn {
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
        }
        
        .modal-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .zoom-info {
            font-size: 14px;
            color: #aaa;
        }
        
        .image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .image-container img {
            max-width: 90%;
            max-height: 90%;
            display: none;
            cursor: grab;
            transform-origin: center;
            transition: transform 0.1s ease;
        }
        
        .modal-footer {
            padding: 8px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            color: #aaa;
            font-size: 12px;
        }
        
        .nav-hint {
            opacity: 0.7;
        }
        
        .loading-spinner {
            position: absolute;
            color: white;
            padding: 20px;
        }
        
        /* 底部加载指示器 */
        #bottomLoader {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        /* 可以调整按钮样式，比如使其更突出 */
        /* .control-panel button#backBtn {
            background: #FF5722;
        }
        
        .control-panel button#backBtn:hover {
            background: #E64A19;
        } */
        
        .slider-container {
            margin-bottom: 25px;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            margin-top: 10px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #1976D2;
            transform: scale(1.1);
        }
        
        .slider::-moz-range-thumb:hover {
            background: #1976D2;
            transform: scale(1.1);
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .slider-container span {
            color: #2196F3;
            font-weight: bold;
        }
        
        .folder-navigation {
            background: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1600px;
            margin: 20px auto;
        }
        
        .breadcrumbs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .breadcrumb-item {
            color: #2196F3;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .breadcrumb-item:after {
            content: "/";
            margin-left: 5px;
            color: #888;
        }
        
        .breadcrumb-item:last-child {
            color: #333;
            font-weight: bold;
        }
        
        .breadcrumb-item:last-child:after {
            content: "";
        }
        
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        
        .folders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .folder-item {
            background: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .folder-item:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .folder-icon {
            color: #2196F3;
            font-size: 20px;
            margin-right: 10px;
        }
        
        .folder-info {
            flex: 1;
        }
        
        .folder-name {
            font-weight: 500;
        }
        
        .folder-count {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }
        
        .empty-message, .no-images-message {
            padding: 20px;
            text-align: center;
            color: #888;
            font-style: italic;
        }
        
        /* 响应式文件夹网格 */
        @media (max-width: 768px) {
            .folders-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .folders-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .folder-item {
                padding: 10px;
            }
        }
        
        /* 添加占位符样式 */
        .image-placeholder {
            position: relative;
            width: 100%;
            background-color: #f0f0f0; /* 占位背景色 */
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        .image-placeholder.loaded {
            background-color: transparent;
        }
        
        .image-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            opacity: 0.8;
        }
        
        .image-placeholder.loaded::before {
            display: none;
        }
        
        .image-placeholder img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        /* 添加排序控制样式 */
        .sort-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        
        .sort-option {
            display: flex;
            align-items: center;
        }
        
        .sort-option label {
            margin-right: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .sort-option select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
        }
        
        .sort-apply-btn {
            padding: 6px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sort-apply-btn:hover {
            background-color: #1976D2;
        }
        
        @media (max-width: 768px) {
            .sort-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .sort-option {
                width: 100%;
            }
        }
        
        .folder-buttons {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 全部图片按钮样式 */
        .button-group .all-folders {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* 添加状态栏样式 */
        #scanStatus {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 4px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            font-size: 12px;
            display: block !important;
            transition: transform 0.3s ease;
        }
        
        #scanStatus.collapsed {
            transform: translateY(100%);
        }
        
        .toggle-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            background: none;
            border: none;
            padding: 0 5px;
            transition: color 0.2s ease;
        }
        
        .toggle-btn:hover {
            color: white;
        }
        
        #expandBtn {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 4px 4px 0 0;
            padding: 2px 10px;
            font-size: 10px;
            cursor: pointer;
            z-index: 999;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        
        #expandBtn.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="folder-navigation">
        <div class="breadcrumbs" id="breadcrumbs">
            <span class="breadcrumb-item active" data-path="">Home</span>
        </div>
        
        <!-- 新增排序控制 -->
        <div class="sort-controls">
            <div class="sort-option">
                <label for="sortBy">排序方式:</label>
                <select id="sortBy" onchange="updateSort()">
                    <option value="name">文件名</option>
                    <option value="created">创建时间</option>
                    <option value="modified">修改时间</option>
                    <option value="random">随机顺序</option>
                </select>
            </div>
            <div class="sort-option">
                <label for="sortOrder">排序顺序:</label>
                <select id="sortOrder" onchange="updateSort()">
                    <option value="asc">正序</option>
                    <option value="desc">倒序</option>
                </select>
            </div>
            <button class="sort-apply-btn" onclick="applySort()">应用排序</button>
        </div>
        
        <div class="folders-container" id="foldersContainer">
            <!-- 文件夹将通过JS动态加载 -->
        </div>
    </div>
    
    <div id="waterfallContainer" class="waterfall-container">
        <!-- 图片将通过JS动态加载 -->
    </div>
    
    <div class="control-panel">
        <button id="refreshBtn" onclick="loadImages()">刷新图片</button>
        <button id="settingsBtn" onclick="showSettings()">布局设置</button>
        <button id="backBtn" onclick="location.href='/'" style="position: fixed; padding: 1rem 1.5rem; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 0.5rem; z-index: 100; bottom: 3vh; left: 2vw; font-size: 1rem; box-shadow: 0 0.125rem 0.625rem rgba(0,0,0,0.2); transition: all 0.3s ease; min-width: 5rem;">返回单图</button>
    </div>
    
    <div id="settingsModal" class="settings-modal">
        <div class="settings-section">
            <h3>瀑布流布局设置</h3>
            
            <div class="slider-container">
                <label for="columnCount">列数: <span id="columnValue">3</span></label>
                <input type="range" id="columnCount" min="1" max="10" value="3" class="slider">
            </div>
            
            <div class="slider-container">
                <label for="columnGap">列间距 (px): <span id="gapValue">15</span></label>
                <input type="range" id="columnGap" min="0" max="50" value="15" class="slider">
            </div>
            
            <div class="slider-container">
                <label for="imageGap">图片间距 (px): <span id="imageGapValue">15</span></label>
                <input type="range" id="imageGap" min="0" max="50" value="15" class="slider">
            </div>
            
            <div class="slider-container">
                <label for="borderRadius">圆角大小 (px): <span id="radiusValue">8</span></label>
                <input type="range" id="borderRadius" min="0" max="50" value="8" class="slider">
            </div>
        </div>
        
        <div class="button-group">
            <button class="primary" onclick="applySettings()">应用设置</button>
            <button class="secondary" onclick="closeSettings()">取消</button>
        </div>
    </div>
    
    <div id="loadingIndicator" class="loading">加载中...</div>
    <div id="overlay" class="overlay"></div>
    
    <!-- 底部加载指示器 -->
    <div id="bottomLoader">加载更多图片...</div>
    
    <!-- 状态栏 -->
    <div id="scanStatus">
        <span id="statusText">正在获取状态...</span>
        <button class="toggle-btn" id="collapseBtn" title="收起状态栏">▼</button>
    </div>
    
    <!-- 添加展开按钮 -->
    <button id="expandBtn" title="展开状态栏">▲ 状态</button>
    
    <script>
        // 全局设置变量
        let waterfallSettings = {
            columnCount: 3,
            columnGap: 15,
            imageGap: 15,
            borderRadius: 8
        };
        
        // 当前文件夹路径
        let currentFolderPath = '';
        
        // 添加排序设置变量
        let sortSettings = {
            sortBy: 'name',
            sortOrder: 'asc'
        };
        
        // 获取排序设置
        function updateSort() {
            sortSettings.sortBy = document.getElementById('sortBy').value;
            sortSettings.sortOrder = document.getElementById('sortOrder').value;
        }
        
        // 应用排序
        function applySort() {
            updateSort();
            // 重置页面并重新加载图片
            currentPage = 1;
            hasMoreImages = true;
            loadImages(1, 20, currentFolderPath);
        }
        
        // 加载服务器端存储的设置
        async function loadSettings() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            try {
                const response = await fetch('/get-waterfall-settings');
                if (!response.ok) {
                    throw new Error('服务器错误');
                }
                
                const settings = await response.json();
                waterfallSettings = settings;
                
                // 应用设置
                applyWaterfallSettings();
                
                // 初始化设置表单
                initSettingsForm();
                
            } catch (error) {
                console.error('加载设置失败:', error);
                // 出错时使用默认设置
                applyWaterfallSettings();
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // 应用设置到页面
        function applyWaterfallSettings() {
            const container = document.getElementById('waterfallContainer');
            container.style.columnCount = waterfallSettings.columnCount;
            container.style.columnGap = waterfallSettings.columnGap + 'px';
            
            const items = document.querySelectorAll('.waterfall-item');
            items.forEach(item => {
                item.style.marginBottom = waterfallSettings.imageGap + 'px';
                const img = item.querySelector('img');
                if (img) {
                    img.style.borderRadius = waterfallSettings.borderRadius + 'px';
                }
            });
        }
        
        // 初始化设置表单
        function initSettingsForm() {
            document.getElementById('columnCount').value = waterfallSettings.columnCount;
            document.getElementById('columnGap').value = waterfallSettings.columnGap;
            document.getElementById('imageGap').value = waterfallSettings.imageGap;
            document.getElementById('borderRadius').value = waterfallSettings.borderRadius;
            
            // 更新显示的值
            document.getElementById('columnValue').textContent = waterfallSettings.columnCount;
            document.getElementById('gapValue').textContent = waterfallSettings.columnGap;
            document.getElementById('imageGapValue').textContent = waterfallSettings.imageGap;
            document.getElementById('radiusValue').textContent = waterfallSettings.borderRadius;
            
            // 添加滑块事件监听器
            setupSliderListeners();
        }
        
        // 设置滑块事件监听器，实时反映设置变化
        function setupSliderListeners() {
            document.getElementById('columnCount').addEventListener('input', function() {
                document.getElementById('columnValue').textContent = this.value;
                // 实时应用列数变化
                const container = document.getElementById('waterfallContainer');
                container.style.columnCount = this.value;
                
                // 延迟检查内容高度
                clearTimeout(this.heightCheckTimer);
                this.heightCheckTimer = setTimeout(() => {
                    checkContentHeight();
                }, 300);
            });
            
            document.getElementById('columnGap').addEventListener('input', function() {
                document.getElementById('gapValue').textContent = this.value;
                // 实时应用列间距变化
                const container = document.getElementById('waterfallContainer');
                container.style.columnGap = this.value + 'px';
            });
            
            document.getElementById('imageGap').addEventListener('input', function() {
                document.getElementById('imageGapValue').textContent = this.value;
                // 实时应用图片间距变化
                const items = document.querySelectorAll('.waterfall-item');
                items.forEach(item => {
                    item.style.marginBottom = this.value + 'px';
                });
            });
            
            document.getElementById('borderRadius').addEventListener('input', function() {
                document.getElementById('radiusValue').textContent = this.value;
                // 实时应用圆角变化
                const imgs = document.querySelectorAll('.waterfall-item img');
                imgs.forEach(img => {
                    img.style.borderRadius = this.value + 'px';
                });
            });
        }
        
        // 显示设置弹窗
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            initSettingsForm();
        }
        
        // 关闭设置弹窗
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        
        // 保存设置到服务器
        async function applySettings() {
            // 获取当前滑块值
            waterfallSettings.columnCount = parseInt(document.getElementById('columnCount').value);
            waterfallSettings.columnGap = parseInt(document.getElementById('columnGap').value);
            waterfallSettings.imageGap = parseInt(document.getElementById('imageGap').value);
            waterfallSettings.borderRadius = parseInt(document.getElementById('borderRadius').value);
            
            // 保证borderRadius为0时确实应用为0px
            const borderRadiusValue = waterfallSettings.borderRadius + 'px';
            
            // 应用到所有图片和占位符
            const imgs = document.querySelectorAll('.waterfall-item img');
            imgs.forEach(img => {
                img.style.borderRadius = borderRadiusValue;
            });
            
            const placeholders = document.querySelectorAll('.image-placeholder');
            placeholders.forEach(placeholder => {
                placeholder.style.borderRadius = borderRadiusValue;
            });
            
            // 保存到服务器
            try {
                const response = await fetch('/save-waterfall-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(waterfallSettings)
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || '保存设置失败');
                }
                
                // 保存成功提示
                const message = document.createElement('div');
                message.textContent = '设置已保存';
                message.style.position = 'fixed';
                message.style.bottom = '80px';
                message.style.right = '20px';
                message.style.padding = '10px 20px';
                message.style.background = '#4CAF50';
                message.style.color = 'white';
                message.style.borderRadius = '4px';
                message.style.zIndex = '2000';
                document.body.appendChild(message);
                
                // 2秒后自动消失
                setTimeout(() => {
                    document.body.removeChild(message);
                }, 2000);
                
            } catch (error) {
                console.error('保存设置失败:', error);
                alert('保存设置失败: ' + error.message);
            }
            
            // 关闭弹窗
            closeSettings();
            
            // 在保存设置成功后，检查内容高度
            setTimeout(() => {
                checkContentHeight();
            }, 500);
        }
        
        // 加载文件夹结构
        async function loadFolders(path = '') {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            try {
                const response = await fetch(`/get-folders?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    throw new Error('加载文件夹失败');
                }
                
                const data = await response.json();
                currentFolderPath = data.currentPath;
                
                // 更新面包屑导航
                updateBreadcrumbs(data.breadcrumbs);
                
                // 显示文件夹
                const foldersContainer = document.getElementById('foldersContainer');
                foldersContainer.innerHTML = '';
                
                if (data.folders.length === 0) {
                    // 如果没有文件夹，显示提示
                    if (data.images.length === 0) {
                        foldersContainer.innerHTML = '<div class="empty-message">此文件夹为空</div>';
                    } else {
                        foldersContainer.innerHTML = '<div class="empty-message">此文件夹没有子文件夹</div>';
                    }
                } else {
                    // 显示所有文件夹
                    data.folders.forEach(folder => {
                        const folderItem = document.createElement('div');
                        folderItem.className = 'folder-item';
                        folderItem.innerHTML = `
                            <span class="folder-icon">📁</span>
                            <div class="folder-info">
                                <div class="folder-name">${folder.name}</div>
                                <div class="folder-count">${folder.imageCount} 张图片</div>
                            </div>
                        `;
                        folderItem.onclick = () => navigateToFolder(folder.path);
                        foldersContainer.appendChild(folderItem);
                    });
                }
                
                // 加载当前文件夹下的图片
                currentPage = 1;
                hasMoreImages = true;
                await loadImages(1, 20, currentFolderPath);
                
            } catch (error) {
                console.error('加载文件夹失败:', error);
                alert('加载文件夹结构失败');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // 更新面包屑导航
        function updateBreadcrumbs(breadcrumbs) {
            const breadcrumbsContainer = document.getElementById('breadcrumbs');
            breadcrumbsContainer.innerHTML = '';
            
            // 添加根目录，将"Root"改为"Home"
            const rootItem = document.createElement('span');
            rootItem.className = 'breadcrumb-item';
            rootItem.textContent = 'Home';
            rootItem.dataset.path = '';
            rootItem.onclick = () => navigateToFolder('');
            breadcrumbsContainer.appendChild(rootItem);
            
            // 添加路径层级
            breadcrumbs.forEach(crumb => {
                const item = document.createElement('span');
                item.className = 'breadcrumb-item';
                item.textContent = crumb.name;
                item.dataset.path = crumb.path;
                item.onclick = () => navigateToFolder(crumb.path);
                breadcrumbsContainer.appendChild(item);
            });
            
            // 标记最后一个为活动状态
            const items = breadcrumbsContainer.querySelectorAll('.breadcrumb-item');
            if (items.length > 0) {
                items[items.length - 1].classList.add('active');
            }
        }
        
        // 导航到特定文件夹
        function navigateToFolder(path) {
            loadFolders(path);
        }
        
        // 修改loadImages函数，添加对页面高度不足的检测
        async function loadImages(page = 1, limit = 20, folderPath = '', retryCount = 0) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const container = document.getElementById('waterfallContainer');
            
            try {
                if (page === 1) {
                    container.innerHTML = '';
                    loadingIndicator.style.display = 'block';
                }
                
                // 添加性能提示
                if (page === 1) {
                    const message = document.createElement('div');
                    message.textContent = '正在加载图片，首次加载可能较慢...';
                    message.style.textAlign = 'center';
                    message.style.padding = '20px';
                    message.style.color = '#666';
                    message.id = 'loading-message';
                    container.appendChild(message);
                }
                
                // 加载图片的请求
                const response = await fetch(`/list-images?page=${page}&limit=${limit}&path=${encodeURIComponent(folderPath)}&sort_by=${sortSettings.sortBy}&sort_order=${sortSettings.sortOrder}`);
                
                // 移除性能提示
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
                
                if (!response.ok) {
                    throw new Error('服务器响应错误: ' + response.status);
                }
                
                const data = await response.json();
                
                const images = data.images;
                const hasMore = data.hasMore;
                
                if (!images || !images.length) {
                    if (page === 1) {
                        container.innerHTML = '<div class="no-images-message">此文件夹中没有图片</div>';
                    }
                    return false;
                }
                
                // 添加图片
                images.forEach(image => {
                    const item = document.createElement('div');
                    item.className = 'waterfall-item';
                    
                    // 创建占位容器
                    const placeholder = document.createElement('div');
                    placeholder.className = 'image-placeholder';
                    
                    const img = document.createElement('img');
                    img.loading = 'lazy'; // 懒加载
                    
                    // 如果有尺寸信息，设置占位符宽高比
                    if (image.width && image.height) {
                        const aspectRatio = (image.height / image.width) * 100;
                        placeholder.style.paddingBottom = `${aspectRatio}%`;
                        // 储存原始宽高比，用于缩放计算
                        img.dataset.aspectRatio = aspectRatio;
                    } else {
                        // 默认宽高比(16:9)
                        placeholder.style.paddingBottom = '75%';
                    }
                    
                    // 图片路径信息
                    const imgPath = typeof image === 'string' ? image : image.path;
                    
                    // 在loadImages函数中修改列数感知的缩略图尺寸
                    function getOptimalThumbnailSize(columnCount) {
                        if (columnCount < 5) return 800; // 5列以下使用800px宽度
                        return 400; // 5列及以上使用400px宽度
                    }
                    
                    // 然后在设置图片src时
                    const thumbnailWidth = getOptimalThumbnailSize(waterfallSettings.columnCount);
                    img.src = `/img-thumbnail/${imgPath}?w=${thumbnailWidth}&t=${Date.now()}`;
                    img.alt = imgPath;
                    img.dataset.fullImage = `/img-static/${imgPath}`;
                    
                    img.onerror = () => {
                        img.src = '/assets/image/error.png';
                    };
                    
                    // 添加点击查看大图功能
                    img.onclick = () => {
                        showFullImage(img.dataset.fullImage, imgPath);
                    };
                    
                    // 图片加载完成后的处理
                    img.onload = () => {
                        // 显示图片，隐藏占位背景
                        img.style.opacity = 1;
                        placeholder.classList.add('loaded');
                    };
                    
                    // 将图片添加到占位符内
                    placeholder.appendChild(img);
                    item.appendChild(placeholder);
                    container.appendChild(item);
                });
                
                // 应用瀑布流设置
                applyWaterfallSettings();
                
                // 检测内容高度是否填满页面，如果没有，自动加载更多
                setTimeout(() => {
                    checkContentHeight();
                }, 500); // 等待图片加载和排列
                
                return hasMore; // 返回是否还有更多图片
                
            } catch (error) {
                console.error('加载图片失败:', error);
                
                // 添加重试机制
                if (retryCount < 3) {
                    console.log(`尝试重新加载 (${retryCount + 1}/3)...`);
                    // 延迟1秒后重试
                    setTimeout(() => {
                        loadImages(page, limit, folderPath, retryCount + 1);
                    }, 1000);
                    return true; // 返回true表示正在重试
                }
                
                if (page === 1) {
                    container.innerHTML = '<div class="no-images-message">加载图片失败，请重试</div>';
                }
                return false;
            } finally {
                if (page === 1) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }
        
        // 添加检查内容高度的函数
        function checkContentHeight() {
            if (isLoading || !hasMoreImages) return;
            
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            
            // 如果内容高度不足以触发滚动，且还有更多图片，自动加载更多
            if (scrollHeight <= clientHeight + 50 && hasMoreImages) {
                console.log('内容高度不足，自动加载更多图片');
                loadMoreImages();
            }
        }
        
        // 显示全尺寸图片的弹窗
        function showFullImage(imageSrc, imageName) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="modal-header">
                    <span class="image-title">${imageName}</span>
                    <div class="modal-controls">
                        <span class="zoom-info">缩放: 100%</span>
                        <span class="close-btn">&times;</span>
                    </div>
                </div>
                <div class="image-container">
                    <img src="" alt="${imageName}">
                </div>
                <div class="modal-footer">
                    <div class="nav-hint">← → 切换图片 | 滚轮缩放 | Ctrl+滚轮切换图片 | 拖拽移动</div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const closeBtn = modal.querySelector('.close-btn');
            const imageContainer = modal.querySelector('.image-container');
            const modalImg = modal.querySelector('img');
            const zoomInfo = modal.querySelector('.zoom-info');
            
            // 显示加载中提示
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            spinner.textContent = '加载中...';
            imageContainer.appendChild(spinner);
            
            // 缩放和拖拽状态变量
            let scale = 1;
            let isDragging = false;
            let startX = 0, startY = 0;
            let translateX = 0, translateY = 0;
            
            // 设置初始样式
            modalImg.style.transform = `scale(1) translate(0px, 0px)`;
            imageContainer.style.cursor = 'grab';
            
            // 关闭按钮事件
            closeBtn.onclick = () => {
                modal.classList.add('fade-out');
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            };
            
            // 点击模态框背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeBtn.onclick();
                }
            });
            
            // 滚轮缩放 - 直接使用滚轮缩放，无需Ctrl键
            modal.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    // Ctrl+滚轮切换图片
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        navigateImages(-1); // 上一张
                    } else {
                        navigateImages(1);  // 下一张
                    }
                } else {
                    // 普通滚轮直接缩放
                    e.preventDefault();
                    
                    // 判断是放大还是缩小
                    const delta = e.deltaY < 0 ? 0.1 : -0.1;
                    let newScale = scale + delta;
                    
                    // 放宽限制范围：从0.1-5改为0.1-10
                    newScale = Math.max(0.1, Math.min(10, newScale));
                    
                    // 更新缩放状态
                    scale = newScale;
                    
                    // 显示缩放百分比
                    zoomInfo.textContent = `缩放: ${Math.round(scale * 100)}%`;
                    
                    // 应用缩放
                    updateTransform();
                }
            });
            
            // 鼠标拖拽 - 在任何缩放级别都可拖动
            imageContainer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                imageContainer.style.cursor = 'grabbing';
            });
            
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            });
            
            window.addEventListener('mouseup', () => {
                isDragging = false;
                imageContainer.style.cursor = 'grab';
            });
            
            // 更新变换
            function updateTransform() {
                modalImg.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
            }
            
            // 键盘导航
            window.addEventListener('keydown', handleKeydown);
            
            function handleKeydown(e) {
                // 确保模态框仍然存在
                if (!document.body.contains(modal)) {
                    window.removeEventListener('keydown', handleKeydown);
                    return;
                }
                
                // 使用左右箭头导航
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateImages(-1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateImages(1);
                } else if (e.key === 'Escape') {
                    closeBtn.onclick();
                }
            }
            
            // 导航到上一张/下一张
            function navigateImages(direction) {
                // 获取当前所有图片
                const allImages = Array.from(document.querySelectorAll('.waterfall-item img'));
                const currentImagePath = imageSrc;
                
                // 找到当前图片的索引
                let currentIndex = allImages.findIndex(img => img.dataset.fullImage === currentImagePath);
                
                if (currentIndex !== -1) {
                    // 计算下一个索引
                    let nextIndex = currentIndex + direction;
                    
                    // 循环导航
                    if (nextIndex < 0) nextIndex = allImages.length - 1;
                    if (nextIndex >= allImages.length) nextIndex = 0;
                    
                    // 获取下一张图片信息
                    const nextImage = allImages[nextIndex];
                    
                    // 关闭当前模态框
                    document.body.removeChild(modal);
                    
                    // 打开新图片
                    showFullImage(nextImage.dataset.fullImage, nextImage.alt);
                }
            }
            
            // 重置状态函数
            function resetZoom() {
                scale = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
                zoomInfo.textContent = `缩放: 100%`;
            }
            
            // 双击重置缩放
            modalImg.addEventListener('dblclick', resetZoom);
            
            // 加载大图
            modalImg.onload = () => {
                spinner.remove();
                modalImg.style.display = 'block';
            };
            
            modalImg.onerror = () => {
                spinner.textContent = '图片加载失败';
            };
            
            // 开始加载大图
            modalImg.src = imageSrc;
            
            // 显示模态框
            setTimeout(() => modal.classList.add('show'), 10);
        }
        
        // 实现无限滚动
        let currentPage = 1;
        let isLoading = false;
        let hasMoreImages = true;
        
        function setupInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if (isLoading || !hasMoreImages) return;
                
                const scrollHeight = document.documentElement.scrollHeight;
                const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                const clientHeight = document.documentElement.clientHeight;
                
                // 当滚动到页面底部500px范围内时加载更多
                if (scrollTop + clientHeight + 500 >= scrollHeight) {
                    loadMoreImages();
                }
            });
        }
        
        async function loadMoreImages() {
            if (isLoading || !hasMoreImages) return;
            
            isLoading = true;
            currentPage++;
            
            // 显示底部加载指示器
            const bottomLoader = document.getElementById('bottomLoader');
            if (bottomLoader) bottomLoader.style.display = 'block';
            
            hasMoreImages = await loadImages(currentPage, 20, currentFolderPath);
            
            isLoading = false;
            if (bottomLoader) bottomLoader.style.display = 'none';
        }
        
        // 在页面加载时初始化排序选项
        window.onload = () => {
            currentPage = 1;
            isLoading = false;
            hasMoreImages = true;
            
            // 初始化排序控件
            document.getElementById('sortBy').value = sortSettings.sortBy;
            document.getElementById('sortOrder').value = sortSettings.sortOrder;
            
            // 初始化状态栏
            initStatusBar();
            
            // 初始化状态栏
            const scanStatusElement = document.getElementById('scanStatus');
            const statusTextElement = document.getElementById('statusText');
            if (scanStatusElement && statusTextElement) {
                scanStatusElement.style.display = 'block';
                statusTextElement.textContent = '正在获取状态...';
            }
            
            // 立即检查一次状态
            checkProgressStatus();
            
            // 先加载设置，再加载文件夹结构
            loadSettings().then(() => {
                loadFolders().then(() => {
                    setupInfiniteScroll();
                    
                    // 设置定时更新状态栏
                    setInterval(checkProgressStatus, 2000);
                });
            });
        };
        
        // 修改刷新按钮的功能，保持当前文件夹路径
        document.getElementById('refreshBtn').onclick = async function() {
            // 清除服务器缓存
            try {
                await fetch('/clear-cache', { method: 'POST' });
                console.log('服务器缓存已清除');
                addLog('服务器缓存已清除');
            } catch (e) {
                console.error('清除缓存失败:', e);
                addLog('清除缓存失败: ' + e.message);
            }
            
            // 重新加载当前文件夹的图片
            currentPage = 1;
            hasMoreImages = true;
            
            // 使用当前文件夹路径重新加载图片，而不是加载根目录
            loadImages(1, 20, currentFolderPath);
        };

        // 进度面板和日志面板相关函数
        function hideProgressPanel() {
            document.getElementById('progressPanel').style.display = 'none';
            addLog('进度面板已关闭');
        }

        function hideLogPanel() {
            document.getElementById('logPanel').style.display = 'none';
        }

        function toggleLogPanel() {
            const logPanel = document.getElementById('logPanel');
            logPanel.style.display = logPanel.style.display === 'none' ? 'block' : 'none';
            addLog('日志面板已' + (logPanel.style.display === 'none' ? '关闭' : '打开'));
        }

        function addLog(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logContent.innerHTML = logEntry + '<br>' + logContent.innerHTML;
        }

        // 检查进度状态
        function checkProgressStatus() {
            // 检查扫描状态
            fetch('/scan-status?manual=true')
                .then(response => response.json())
                .then(data => {
                    updateScanStatus(data);
                })
                .catch(error => {
                    console.error('获取扫描状态失败:', error);
                });
        }

        // 更新状态栏
        function updateScanStatus(data) {
            const scanStatusElement = document.getElementById('scanStatus');
            const statusTextElement = document.getElementById('statusText');
            
            if (!scanStatusElement || !statusTextElement) {
                console.error('找不到状态栏元素');
                return;
            }
            
            let statusText = '';
            
            if (data.is_scanning && data.is_manual_scan) {
                // 扫描中状态
                statusText = `扫描中: ${data.current_file || '未知'} | 进度: ${data.processed_files || 0}/${data.total_files || 0} | 有效图片: ${data.valid_images || 0} | 用时: ${data.duration || 0}秒`;
            } else {
                // 就绪状态，显示完整信息
                statusText = `就绪 | 总文件数: ${data.total_files || 0} | 有效图片: ${data.valid_images || 0}`;
                
                // 如果有缩略图信息，添加到状态栏
                fetch('/thumbnail-status')
                    .then(response => response.json())
                    .then(thumbData => {
                        if (thumbData.is_generating) {
                            statusText += ` | 缩略图: ${thumbData.processed || 0}/${thumbData.total || 0}`;
                        } else if (thumbData.total > 0) {
                            statusText += ` | 缩略图: 已完成 (${thumbData.total || 0}张)`;
                        }
                        statusTextElement.textContent = statusText;
                    })
                    .catch(error => {
                        console.error('获取缩略图状态失败:', error);
                        statusTextElement.textContent = statusText;
                    });
            }
            
            // 如果是扫描状态，直接更新内容
            if (data.is_scanning && data.is_manual_scan) {
                statusTextElement.textContent = statusText;
            }
        }

        // 检查是否有正在进行的任务
        function checkForActiveProcesses() {
            fetch('/scan-status?manual=true')
                .then(response => response.json())
                .then(data => {
                    if (data.is_scanning) {
                        addLog('检测到正在进行的扫描任务');
                    }
                    
                    // 检查缩略图状态
                    fetch('/thumbnail-status')
                        .then(response => response.json())
                        .then(data => {
                            if (data.is_generating) {
                                addLog('检测到正在进行的缩略图生成任务');
                            }
                        })
                        .catch(() => {
                            // 忽略错误
                        });
                })
                .catch(error => {
                    console.error('检查进程状态失败:', error);
                });
        }

        // 初始化状态栏的收起/展开功能
        function initStatusBar() {
            const scanStatus = document.getElementById('scanStatus');
            const collapseBtn = document.getElementById('collapseBtn');
            const expandBtn = document.getElementById('expandBtn');
            
            // 从本地存储加载状态栏状态
            const isCollapsed = localStorage.getItem('statusBarCollapsed') === 'true';
            if (isCollapsed) {
                scanStatus.classList.add('collapsed');
                expandBtn.classList.add('visible');
            }
            
            // 收起按钮
            collapseBtn.addEventListener('click', () => {
                scanStatus.classList.add('collapsed');
                expandBtn.classList.add('visible');
                localStorage.setItem('statusBarCollapsed', 'true');
            });
            
            // 展开按钮
            expandBtn.addEventListener('click', () => {
                scanStatus.classList.remove('collapsed');
                expandBtn.classList.remove('visible');
                localStorage.setItem('statusBarCollapsed', 'false');
            });
        }
    </script>
</body>
</html> 